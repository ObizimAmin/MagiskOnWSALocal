name: Build MagiskOnWSALocal

on:
  workflow_dispatch:
    inputs:
      wsa_version:
        description: 'Select WSA version choice number'
        required: true
        default: '1'
      architecture:
        description: 'Select architecture choice number'
        required: true
        default: '1'
      magisk_version:
        description: 'Select Magisk version choice number'
        required: true
        default: '1'
      root_solution:
        description: 'Select root solution choice number'
        required: true
        default: '1'
      compress_output:
        description: 'Compress output choice number'
        required: true
        default: '1'

jobs:
  build:
    name: Build WSA with Magisk
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          python3 python3-venv python3-pip \
          aria2 unzip p7zip-full \
          whiptail dialog libnewt0.52 python3-newt \
          xz-utils lz4 cpio expect

    - name: Set up Python venv
      run: |
        python3 -m venv venv
        . venv/bin/activate
        pip install --upgrade pip

    - name: Build with automated inputs
      run: |
        chmod +x scripts/run.sh

        cat << 'EOF' > auto.exp
        #!/usr/bin/expect -f
        set timeout -1
        spawn ./scripts/run.sh

        expect "Select WSA version"
        send "${{ github.event.inputs.wsa_version }}\r"

        expect "Select architecture"
        send "${{ github.event.inputs.architecture }}\r"

        expect "Select Magisk version"
        send "${{ github.event.inputs.magisk_version }}\r"

        expect "Select root solution"
        send "${{ github.event.inputs.root_solution }}\r"

        expect "Do you want to compress the output"
        send "${{ github.event.inputs.compress_output }}\r"

        expect eof
        EOF

        chmod +x auto.exp
        ./auto.exp

    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: wsa-magisk-build
        path: ./output/
