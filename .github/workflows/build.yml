name: Build MagiskOnWSALocal

on:
  workflow_dispatch:

jobs:
  build:
    name: Build WSA with Magisk
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Prepare environment
      run: |
        sudo apt update
        sudo apt install -y \
          python3 \
          python3-venv \
          python3-pip \
          aria2 \
          unzip \
          p7zip-full \
          whiptail \
          dialog \
          libnewt0.52 \
          python3-newt \
          xz-utils \
          lz4 \
          cpio \
          expect


    - name: Set up Python venv
      run: |
        python3 -m venv venv
        . venv/bin/activate
        pip install --upgrade pip

    - name: Build with automated inputs
      run: |
        chmod +x scripts/run.sh

        # Create an Expect script to send menu choices.
        # These numbers correspond to menu positions; adjust them if needed.
        cat << 'EOF' > auto.exp
        #!/usr/bin/expect -f
        set timeout -1
        spawn ./scripts/run.sh
        expect "Select WSA version"
        send "1\r"
        expect "Select architecture"
        send "1\r"
        expect "Select Magisk version"
        send "1\r"
        expect "Select root solution"
        send "1\r"
        expect "Do you want to compress the output"
        send "1\r"
        expect eof
        EOF

        chmod +x auto.exp
        ./auto.exp

    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: wsa-magisk-build
        path: ./output/
